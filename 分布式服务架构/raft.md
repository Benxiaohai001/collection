# 是什么？
分布式一致性的一种共识算法，共识就是多个节点对某一事件达成一致的算法。即及时部分节点异常，网络故障等问题，也不影响整体的服务可用性。
# 什么是共识？
多个节点就值达成一致。
# leader选举
初始化都是follower => 无法与leader保持心跳，认为没有leader => 转换为Candidate状态 => Candidate向其他节点请求投票，同意自己成为leader => 候选人票超过n/2 +1   => 被选举为leader => leader向所有follower周期性同步心跳=> follower在超过周期内leader的心跳 => follower发起一次新的leader选举=>
# 日志同步
1. `leader`接受来之客户端请求，将至封装成`log entry`并追加到自己的日志中；
2. `leader`并行向系统中所有节点发送日志赋值消息；
3.  `follower`接收到消息的节点，确认消息没有问题，则将`log entry`追加到自己的日志中，并向`leader`返回ACK表示接受成功；
4. leader若在随机超时时间内接收到大多数的节点的ACK，则将log entry应用到状态机向客户返回成功。
# 多主/分裂脑问题
`当集群中网络中断，比如5个节点，两个可以通信，其余三个可以通信，且另外三个重新选主，并且两个子集群的主节点分别写入了数据，如何解决冲突？`
当出现多主，写入不同数据时，通过选举安全性、日志匹配原则等机制解决冲突。具体是靠日志的索引和任期号来识别正确的日志。
## 检测多主问题
* 心跳机制
发生在网络分区或者领导者未能及时发送心跳的情况下。
* 日志冲突
* 监控工具
prometheus+ grafana
## 解决问题的原则
* 任期号
任期号大的具有优先领导权
* 日志匹配规则
比较两个日志最后一条条目：
    * 如果任期号相同，索引号大的更新；
    * 任期号不同，任期号大的更新
* 强制一致性
    一旦确定领导者，丢弃与领导者日志不一样的日志条目。Raft通过`AppendEntries RPC`来同步日志，并保证所有节点的日志最终一致性。
## 处理步骤
### 选举超时和随机化
* 选举超时
每个follower选举超时时间是随机的，通常在150ms-300ms之间；降低多个节点同一时刻发起选举，减少多主情况。
### 处理网络分区
* 网络分区
Raft要求所有领导者必须获得大多数节点的支持才能继续处理请求。意味着如果一个子集中，如果节点数少于集群总数的一半，他无法选举出新的leader。
* 重新连接后的一致性
最终一致性，保证最终留下一个leader，保留一份日志。
